# Database Schema Documentation

This document provides detailed information about the database schema for the PDF Management System.

## Table of Contents

- [Overview](#overview)
- [Tables](#tables)
- [Relationships](#relationships)
- [Indexes](#indexes)
- [Migrations](#migrations)
- [Sample Data](#sample-data)

## Overview

The PDF Management System uses a simple, efficient database schema designed for managing PDF file metadata. The system uses MySQL/MariaDB as the relational database and implements soft deletes for data retention.

**Database Configuration:**

- **Engine:** InnoDB
- **Charset:** utf8mb4
- **Collation:** utf8mb4_unicode_ci
- **Timezone:** UTC

## Tables

### pdf_files

Main table for storing PDF file metadata and tracking file lifecycle.

**Table Name:** `pdf_files`

**Schema:**

| Column            | Type            | Null | Key | Default | Extra          | Description                      |
| ----------------- | --------------- | ---- | --- | ------- | -------------- | -------------------------------- |
| id                | BIGINT UNSIGNED | NO   | PRI | NULL    | AUTO_INCREMENT | Primary key, unique identifier   |
| filename          | VARCHAR(255)    | NO   |     | NULL    |                | System-generated unique filename |
| original_filename | VARCHAR(255)    | YES  |     | NULL    |                | Original filename from upload    |
| filepath          | VARCHAR(500)    | NO   |     | NULL    |                | Relative path in storage         |
| size              | BIGINT          | YES  |     | NULL    |                | File size in bytes               |
| status            | ENUM            | NO   | MUL | NULL    |                | Current status of the PDF        |
| created_at        | TIMESTAMP       | YES  |     | NULL    |                | Record creation timestamp        |
| updated_at        | TIMESTAMP       | YES  |     | NULL    |                | Last update timestamp            |
| deleted_at        | TIMESTAMP       | YES  | MUL | NULL    |                | Soft delete timestamp            |

**Status ENUM Values:**

- `CREATED` - PDF generated by the system
- `UPLOADED` - PDF uploaded by a user
- `DELETED` - PDF marked as deleted (soft delete)

**Constraints:**

- Primary Key: `id`
- Unique: None (allows duplicate filenames as they're generated uniquely)
- Check: `status` must be one of the ENUM values

### users (Future)

_Note: Users table exists from Laravel default but is not currently used. Future authentication implementation will utilize this table._

## Relationships

### Current Relationships

Currently, the schema consists of a single independent table with no foreign key relationships.

```
┌─────────────────────────────────┐
│         pdf_files               │
│  (No relationships currently)   │
└─────────────────────────────────┘
```

### Future Planned Relationships

**Phase 1: User Authentication**

```
┌─────────────┐         ┌─────────────────────┐
│    users    │────────<│     pdf_files       │
│             │  1:N    │                     │
└─────────────┘         └─────────────────────┘
```

- Add `user_id` foreign key to `pdf_files`
- Track which user created/uploaded each PDF

**Phase 2: Categories & Tags**

```
┌─────────────┐         ┌─────────────────────┐
│ categories  │────────<│     pdf_files       │
│             │  1:N    │                     │
└─────────────┘         └─────────────────────┘
                                 │
                                 │ N:N
                                 │
┌─────────────┐         ┌─────────────────────┐
│    tags     │<────────│     pdf_tags        │
│             │         │  (pivot table)      │
└─────────────┘         └─────────────────────┘
```

**Phase 3: Sharing & Permission**

```
┌─────────────┐         ┌─────────────────────┐
│    users    │<────────│   shared_files      │
│             │         │                     │
└─────────────┘         └─────────────────────┘
                                 │
                                 │
                                 v
                        ┌─────────────────────┐
                        │     pdf_files       │
                        │                     │
                        └─────────────────────┘
```

## Indexes

### Primary Index

**Index Name:** `PRIMARY`

- **Columns:** `id`
- **Type:** BTREE
- **Unique:** YES
- **Purpose:** Primary key lookup

### Additional Indexes

**Index Name:** `pdf_files_status_index`

- **Columns:** `status`
- **Type:** BTREE
- **Unique:** NO
- **Purpose:** Fast filtering by status (used in list endpoint)

**Index Name:** `pdf_files_deleted_at_index`

- **Columns:** `deleted_at`
- **Type:** BTREE
- **Unique:** NO
- **Purpose:** Efficient soft delete queries

### Composite Index (Recommended for Future)

```sql
-- For filtering by status and pagination
CREATE INDEX pdf_files_status_created_at_index
ON pdf_files (status, created_at DESC);
```

## Migrations

### Migration File

**File:** `database/migrations/2026_02_05_100839_create_pdf_files_table.php`

**Content:**

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use App\Constant\AppConstant;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('pdf_files', function (Blueprint $table) {
            $table->id();
            $table->string('filename', 255);
            $table->string('original_filename', 255)->nullable();
            $table->string('filepath', 500);
            $table->bigInteger('size')->nullable();
            $table->enum('status', [
                AppConstant::PDF_STATUS_CREATED,
                AppConstant::PDF_STATUS_UPLOADED,
                AppConstant::PDF_STATUS_DELETED
            ]);
            $table->timestamps();
            $table->softDeletes()->nullable();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('pdf_files');
    }
};
```

### Running Migrations

```bash
# Run all pending migrations
php artisan migrate

# Reset database and run all migrations
php artisan migrate:fresh

# Rollback last migration batch
php artisan migrate:rollback

# Check migration status
php artisan migrate:status
```

## Sample Data

### Example Records

#### Generated PDF Record

```sql
INSERT INTO pdf_files (
    filename,
    original_filename,
    filepath,
    size,
    status,
    created_at,
    updated_at
) VALUES (
    'report_20260206_143025_aBc123.pdf',
    'Monthly Sales Report.pdf',
    'uploads/pdf/report_20260206_143025_aBc123.pdf',
    156789,
    'CREATED',
    '2026-02-06 14:30:25',
    '2026-02-06 14:30:25'
);
```

#### Uploaded PDF Record

```sql
INSERT INTO pdf_files (
    filename,
    original_filename,
    filepath,
    size,
    status,
    created_at,
    updated_at
) VALUES (
    'upload_20260206_143530_xYz789.pdf',
    'document.pdf',
    'uploads/pdf/upload_20260206_143530_xYz789.pdf',
    245678,
    'UPLOADED',
    '2026-02-06 14:35:30',
    '2026-02-06 14:35:30'
);
```

#### Soft Deleted PDF Record

```sql
INSERT INTO pdf_files (
    filename,
    original_filename,
    filepath,
    size,
    status,
    created_at,
    updated_at,
    deleted_at
) VALUES (
    'report_20260206_140000_OldFile.pdf',
    'Old Report.pdf',
    'uploads/pdf/report_20260206_140000_OldFile.pdf',
    98765,
    'DELETED',
    '2026-02-06 14:00:00',
    '2026-02-06 15:00:00',
    '2026-02-06 15:00:00'
);
```

## Query Examples

### Common Queries

#### 1. Select All Active PDFs

```sql
SELECT * FROM pdf_files
WHERE deleted_at IS NULL
ORDER BY created_at DESC;
```

#### 2. Select PDFs by Status

```sql
SELECT * FROM pdf_files
WHERE status = 'UPLOADED'
  AND deleted_at IS NULL
ORDER BY created_at DESC;
```

#### 3. Get PDF Count by Status

```sql
SELECT status, COUNT(*) as count
FROM pdf_files
WHERE deleted_at IS NULL
GROUP BY status;
```

#### 4. Find Large PDFs (> 1MB)

```sql
SELECT filename, original_filename, size,
       ROUND(size / 1024 / 1024, 2) as size_mb
FROM pdf_files
WHERE size > 1048576
  AND deleted_at IS NULL
ORDER BY size DESC;
```

#### 5. Get Recent Uploads (Last 7 Days)

```sql
SELECT * FROM pdf_files
WHERE status = 'UPLOADED'
  AND created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
  AND deleted_at IS NULL
ORDER BY created_at DESC;
```

#### 6. Soft Deleted PDFs

```sql
SELECT * FROM pdf_files
WHERE deleted_at IS NOT NULL
ORDER BY deleted_at DESC;
```

#### 7. Storage Usage Statistics

```sql
SELECT
    status,
    COUNT(*) as file_count,
    SUM(size) as total_bytes,
    ROUND(SUM(size) / 1024 / 1024, 2) as total_mb,
    ROUND(AVG(size) / 1024 / 1024, 2) as avg_mb
FROM pdf_files
WHERE deleted_at IS NULL
GROUP BY status;
```

## Data Integrity

### Constraints

1. **Filename Uniqueness:**
    - System generates unique filenames using timestamp + random string
    - Format: `{type}_{YYYYMMDD_HHiiss}_{random6}.pdf`
    - Example: `report_20260206_143025_aBc123.pdf`

2. **File Size:**
    - Stored in bytes (BIGINT)
    - Upload limit: 10,485,760 bytes (10MB)
    - Generated PDFs: variable size

3. **Filepath:**
    - Relative to storage root: `uploads/pdf/`
    - Full path: `storage/app/public/uploads/pdf/{filename}`
    - Public access: `/storage/uploads/pdf/{filename}`

4. **Status Transition Rules:**

    ```
    [Upload] → UPLOADED → DELETED
    [Generate] → CREATED → DELETED

    Notes:
    - DELETED is terminal state (no transitions out)
    - Cannot delete already DELETED files (returns 409)
    ```

### Soft Deletes

**Implementation:**

- Uses Laravel's `SoftDeletes` trait
- Sets `deleted_at` timestamp instead of removing record
- Updates `status` to 'DELETED'
- Physical file remains in storage (for recovery)

**Benefits:**

- Data recovery possible
- Audit trail maintained
- No foreign key violations

**Query Behavior:**

```php
// Without soft deletes (raw query)
PdfFile::all(); // Includes deleted

// With soft deletes (Eloquent)
PdfFile::all(); // Excludes deleted
PdfFile::withTrashed()->get(); // Includes deleted
PdfFile::onlyTrashed()->get(); // Only deleted
```

## Performance Considerations

### Indexing Strategy

1. **Status Index:**
    - Most queries filter by status
    - Improves list endpoint performance

2. **Deleted_at Index:**
    - Soft delete queries are common
    - Speeds up active record filtering

3. **Created_at Index (Future):**
    - Date range queries
    - Ordering by recency

### Query Optimization

**Pagination:**

```php
// Efficient pagination with offset/limit
PdfFile::where('status', 'UPLOADED')
       ->orderBy('created_at', 'desc')
       ->offset(($page - 1) * $limit)
       ->limit($limit)
       ->get();
```

**Count Optimization:**

```php
// Count without loading full records
$total = PdfFile::where('status', 'UPLOADED')->count();
```

### Storage Growth Management

**Recommendations:**

1. Implement cleanup task for old deleted files
2. Archive old records to separate table/database
3. Set retention policy (e.g., 30 days for deleted files)
4. Monitor storage usage with scheduled reports

**Cleanup Query (Example):**

```sql
-- Find files deleted > 30 days ago
SELECT * FROM pdf_files
WHERE deleted_at IS NOT NULL
  AND deleted_at < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

## Backup and Recovery

### Backup Strategy

**Daily Backups:**

```bash
# Dump database
mysqldump -u root -p pdf_management_system > backup_$(date +%Y%m%d).sql

# Backup storage files
tar -czf storage_backup_$(date +%Y%m%d).tar.gz storage/app/public/uploads
```

**Restore:**

```bash
# Restore database
mysql -u root -p pdf_management_system < backup_20260206.sql

# Restore storage
tar -xzf storage_backup_20260206.tar.gz
```

## Future Enhancements

### Planned Schema Changes

1. **User Association (v2.0)**
    - Add `user_id` column to `pdf_files`
    - Foreign key to `users.id`
    - Add index on `user_id`

2. **Categories (v2.1)**
    - New `categories` table
    - Add `category_id` to `pdf_files`
    - Hierarchical categories support

3. **Tags (v2.2)**
    - New `tags` table
    - New `pdf_tags` pivot table
    - Many-to-many relationship

4. **Versioning (v3.0)**
    - New `pdf_versions` table
    - Track file changes over time
    - Version history

5. **Sharing & Permissions (v3.1)**
    - New `shared_files` table
    - Permission levels (read, write, admin)
    - Expiration dates

### Migration Strategy

Each version will include:

- New migration files
- Backward compatibility
- Rollback support
- Data migration scripts (if needed)

---

**Document Version:** 1.0  
**Last Updated:** 2026-02-06  
**Maintainer:** Development Team
